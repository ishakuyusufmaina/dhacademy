<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Center</title>
  <link rel="stylesheet" href="index.css">
  <script src="feesrule.js"></script>
</head>
<body>
  
  <div class="container">
    <img class="logo" src="../../logo.png">
    <hr>
    <h1>SCHOOL FEES</h1>
    <select id="sessionSelect">
      <option value="">-session-</option>
    </select>
    <!--
    <select>
      <option value="">-section-</option>
    </select>
    <select>
      <option value="">-class-</option>
    </select>
    -->
    <label for="searchBy">Search by</label>
    <select id="searchBy">
      <option value="id">Student ID</option>
      <option value="names">Student Name</option>
      <!--option value="parentId">Parent ID</option-->
      <!--option value="parentName">Parent Name</option-->
    </select>

    <!--label for="searchInput">Enter value</label-->
    <input type="text" id="searchInput" placeholder="Enter value here..." />

    <button class="button" id="searchBtn">Search <span class="spinner"></span></button>

    <!--a href="../../admin/student/registration.html" class="link-button">Register New Student</a-->

    <div class="results" id="resultsBox">
      <h3>Search Results</h3>
      <div id="resultsContent">
        <!-- Search results will appear here -->
      </div>
    </div>
  </div>

   <script src="../../config.js"></script>
  <script src="../../batch2.js"></script>
  <script src="utility.js"></script>
  <script type="module" defer>
  /*
    */
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, onSnapshot, sum, getAggregateFromServer, query, limit, where, getDocs, collection, doc, setDoc, getDoc, runTransaction} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
     // import {getDatabase, set, ref, onValue, child, get } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";
       
  
  
 // const schoolId="almadeenah";
    
      const app = initializeApp(firebaseConfig);
    const paybook = initializeApp(paybookConfig, "paybook");
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const paydb = getFirestore(paybook);
  
const terms = ["first term", "second term", "third term"];
  var session;
  let sessionsRef = doc(db, schoolId, "sessions");
  let sessionsDoc = await getDoc(sessionsRef);
  if (sessionsDoc.exists()){
    let sessions =  sessionsDoc.data().sessions;
     sessions= sessions.sort((a, b)=>b.no - a.no);
     sessions.forEach(session=>{
      let opt = new Option(session.year +', '+ terms[session.term].toUpperCase());
      opt.value = sessionKey(session);
      sessionSelect.append(opt);
    });
    session = sessions[0];
    sessionSelect.value = sessionKey(session);
    sessionSelect.onchange = _=>{
      let i = _.target.selectedIndex;
      if (i) session = sessions[i-1];
      
    }
      //sessionSelect.firstChild.nextElementSibling.selected = true;
  }
  
  
  let user = await new Promise(resolve=>
  onAuthStateChanged(auth, u=> resolve(u))
  );
  let id = user.email.replace(/@.*/, "");
  console.log(id);
  
  
    var teachers;
     let teachersRef = doc(db, schoolId, "teachers");
    let teachersDoc = await getDoc(teachersRef);
  teachers = teachersDoc.exists()? teachersDoc.data() : {}
    let teacher = teachers[id];


    let sectionRef = doc(db, schoolId, "section");
  let sections = (await getDoc(sectionRef)).data();
  const classSection = {};
  classSection.get = cls=>classSection[cls.toLowerCase()];
  
  let sects = teacher.adminFunctions.feesRecord.resources;
  Object.keys(sections)
  .forEach(sectK=>{
    let section = sections[sectK];
    let classes = section.classes;
   // console.log(classes);
    classes.forEach(cls=>{
      classSection[cls.toLowerCase()] = sectK;
    })
  })
  
    const select = document.getElementById("searchBy");
    const input = document.getElementById("searchInput");
    const searchBtn = document.getElementById("searchBtn");
    const resultsBox = document.getElementById("resultsBox");
    const resultsContent = document.getElementById("resultsContent");

    // Dynamic placeholder update
    select.addEventListener("change", () => {
      const selected = select.options[select.selectedIndex].text;
      input.placeholder = `Enter ${selected.toLowerCase()}...`;
    });

    // Fake search handler (can be replaced with real logic or API call)
    searchBtn.addEventListener("click", async () => {
      let sess = sessionSelect.value;
      if (!sess){
        alert("Please select a session and term");
        return;
      }
    //  console.log(sess);
      let sessRef = doc(db, schoolId, sess.replace("_", ""));
      const feesRuleRef = doc(db, schoolId, "payments", "rules", sessionSelect.value);
      const rulesDoc = await getDoc(feesRuleRef);
      
      let sessDoc = await getDoc(sessRef);
    //  console.log(JSON.stringify(sessDoc.data()));
      let fees = sessDoc.data()?.fees;
      if (!rulesDoc.exists()) {
        alert("Fees rule not set");
        return;
      }
      const rules = rulesDoc.data().rules;
      
      const queryType = select.value;
      const queryValue = input.value.trim().toLowerCase();
      
     // console.log(queryValue);

      if (!queryValue) {
        resultsBox.style.display = "none";
        return;
      }

      // Placeholder content (simulate result)
  //    let studentRef = doc(db, schoolId, "db", "students");
      searchBtn.classList.add("loading");
      let q;
      let constraint = [];
      if (queryType=="names"){
        let arr = queryValue.split(" ");
        let newArr = [[arr[0]]];
        arr.forEach((name, i)=>{
          if (i) newArr.push(newArr[i-1].concat(name));
          constraint.push(where("names", "array-contains-any", [name]));

        })
        newArr = newArr.reverse();
    //    console.log(newArr);
        q = query(collection(db, schoolId, "db", "students"), where("section", "in", sects), where("names", "array-contains-any", ...newArr));
      //  console.log(sects);
      } else {
    //    console.log(queryType);
     //   console.log(queryValue);
        q = query(collection(db, schoolId, "db", "students"), where("section", "in", sects), where(queryType, "==", queryValue));

     //   console.log(sects);
      }
      let studentDocs = await getDocs(q);
      searchBtn.classList.remove("loading");
      let resultHTML = "";
      const students = [];
      
      studentDocs.forEach(async (doc)=> {
        let student = doc.data();
       // console.log(JSON.stringify(student));
      
        student.classes??=[student.class];
        student.classes.forEach( async cls=>{
        let sectStd = {};
          for (const key in student){
            sectStd[key] = student[key];
          }
          sectStd.class = cls;
          
        //  console.log(sectStd.class);
        let q = getQuery({
          id: sectStd.id, 
         "class": sectStd.class,
          term: session.term+"",
          year: session.year
        });
          console.log(Number(session.term+1));
        let pbQuery = queryPB({
          id: sectStd.id.replaceAll("/", "_"), 
         "class": sectStd.class,
          term: Number(session.term),
          session: session.year.replaceAll(" ", ""),
          schoolId
        });
  
          let snapshot;
       try{
         snapshot = await getAggregateFromServer(q, {
          totalPaid: sum("amount")
        }); 
       } catch(e){
         resultsBox.innerHTML = e.message;
       }
        let amount = snapshot.data().totalPaid;
        sectStd.amountPaid = amount;
        sectStd.paymentQuery = pbQuery;
      //  console.log(amount);
        students.push(sectStd)
        presentResult();
        onSnapshot(pbQuery, snap => {
            let total = 0;
            let timestamps = [];
            snap.forEach(d => {
              total += d.data().amount;
              timestamps.push(d.data().timestamp);
              console.log(d.data().timestamp);
            });
          timestamps = timestamps
          .sort((a, b) => b.toMillis() - a.toMillis())
          .map(ts=>formatTimestamp(ts));
          sectStd.amountPaid = total;
            sectStd.lastPaidAt = timestamps[0];
           //sectStd.payment = 
            console.log("amount paid", student.name, total);
            sectStd.render?.();
        });
     });
      })
     
      function presentResult(){
        //console.log("there is student");
       populateResults(students, rules);
        resultsBox.style.display = "block";

      }
      if (students.length){
          presentResult();
        return;
      } else {
        resultHTML = `
        <p>No student with ${queryType}
         ${queryValue} found.</p>   
      `;
        
      }

      resultsContent.innerHTML = resultHTML;
      resultsBox.style.display = "block";
    });
  
  

  
  function populateResults(students, rules) {
    const container = document.getElementById("resultsContent");
    container.innerHTML = ""; // Clear previous results

  students.forEach(student => {
   // console.log(typeof student.names);
    const resultElm = document.createElement("div");
    resultElm.className = "resultElm";
    let stdSect = classSection.get(student.class);
    student.section = stdSect;
   // console.log(student.class);
   // console.log(stdSect);
    let stdRules = getApplicableRules(student, rules);
    evaluateRules(priorityRule, stdRules);
    let rule = getAppliedRule(stdRules)??{amount: 0};
    
    let dueFee = Number(rule.amount);
    console.log(student.name, JSON.stringify(stdRules));

    //let stdFees = student.schoolFees?? {};
    
     render();
    let n = 1;
    function render(){
       let amountPaid = Number(student.amountPaid);
   //   console.log(dueFee);
      let outstanding = dueFee - amountPaid; 
      student.render = render;
      resultElm.innerHTML = `
      <img src="${student.picURL??"blank-passp.jpg"}" alt="Picture of ${student.name}" class="studentPic">
      <div class="studentInfo">
        <div class="studentName">${student.name.toUpperCase()}</div>
        <div class="studentClass">${student.class.toUpperCase()}</div>
        <div class="studentClass">Amount Paid: ₦${amountPaid}</div>
       <div class="studentClass">Outstanding: ₦${outstanding}</div>
      <div class="studentClass">Last timestamp: ${student.lastPaidAt??"------"}</div>

      </div>
      <div class="account studentInfo">
        <button class="button">Record payment</button>
      </div>
      `;
    const acElm = resultElm.querySelector(".account");
    if (student.account){
      const acc =student.account; 
      acElm.innerHTML = `
        <div class="studentName">Account</div>
      <div class="studentClass">ACC. No: ${acc.accountNumber}</div>
       <div class="studentClass">ACC. Name: ${acc.accountName}</div>
       <div class="studentClass">Bank. Name: ${acc.bankName}</div>      
      `;
    } else {
      let btn = acElm.querySelector("button");
      btn.onclick = async e=>{
        window.location.href = "payment-form.html?id="+student.id;
        return;
        btn.innerHTML = "requesting..";
        let data = await createDVA(student.id.replaceAll("/", "_"), schoolId, "batch2", "2025/2026", 1);
        btn.innerHTML = "request sent";
       // console.log(data.success, JSON.stringify(data));
        let stdRef = doc(db, schoolId, "db", "students", student.id.replaceAll("/", "_"));
        onSnapshot(stdRef, (docSnap)=>{
          let data = docSnap.data();
          for (const k in data){
            student[k] = data[k];
          }
          render();
        })
      }//end of onclick event
    } //end of else
    
      
    /*resultElm.onclick = e=>{
      localStorage.setItem("student", JSON.stringify(student));
      localStorage.setItem("session", JSON.stringify(session));
      localStorage.setItem("fee", dueFee);
      
      window.location.href = "entry.html";
    }*/
    } //end of render
    container.appendChild(resultElm);
  }); //end of forEach
  }
      
  function key(token){
      return token.replaceAll(" ","").replaceAll("/", "_").replaceAll(",", "").trim();
    }
  function sessionKey(session){
      return key(session.year+"term"+session.term);
    }
  
  
  
  function getQuery(sfCoord){
    //console.log(JSON.stringify(sfCoord));
    let ref = collection(db, schoolId, "db", "fees");
//    console.log(sfCoord.term);
  //  console.log(sfCoord.class);
    return query(ref, 
    where("student", "==", sfCoord.id),
    where("class", "==", sfCoord.class), 
    where("year", "==", sfCoord.year), 
    where("term", "==", sfCoord.term)
    
    );
  }
  
 function queryPB(sfCoord){
    console.log(JSON.stringify(sfCoord));
    let ref = collection(paydb, "payments");
    //console.log(sfCoord.term);
   // console.log(sfCoord.class);
    return query(ref, 
      where("studentId", "==", sfCoord.id),
      where("class", "==", sfCoord.class), 
      where("session", "==", sfCoord.session), 
      where("term", "==", sfCoord.term),
      where("schoolId", "==", sfCoord.schoolId)
    );
  }
  
  
  async function createDVA(studentId, schoolId, schoolBatch, session, term){
    const response= await fetch("http://cfx-mainafly.netlify.app/.netlify/functions/assign-dva", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        studentId, schoolId, schoolBatch, session, term
      }),
    });
    const data = await response.json();
    return data;
  }
  
  
  function getSectionByClass(cls, sections){
     let section = null;
     for (const sect in sections){    
       let classes = sections[sect].classes.map(c=>key(c).toLowerCase())
       console.log(classes, cls);
       if (classes.includes(key(cls).toLowerCase())) {
         section = sect;   
       }
     } 
     return section
  }
  
  function formatTimestamp(ts) {
  const d = ts.toDate();

  return `${d.getFullYear()}-${
    String(d.getMonth() + 1).padStart(2, "0")
  }-${String(d.getDate()).padStart(2, "0")}
  ${String(d.getHours()).padStart(2, "0")}:${
    String(d.getMinutes()).padStart(2, "0")
  }`;
}
  </script>
</body>
</html>
