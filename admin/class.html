<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>STUDENT</title>
  <link rel="stylesheet" href="../styles/students.css">
</head>
<body>
  <h1 id="head">Students</h1>
  <div>
    <select id="sessionSelect">
      <option> -select session- </option>
    </select>
    <select id="classSelect">
      <option value=""> -select class- </option>
    </select>
  </div>

  <table>
    <thead>
      <tr>
        <th>Passport</th>
        <th>ID</th>
        <th>Name</th>
        <th>Gender</th>
        <th>Religion</th>
        <th>Parent</th>
      </tr>
    </thead>
    <tbody id="table"></tbody>
  </table>

  <button id="add">Add</button>
  <button id="saveBtn">Save</button>
  <button id="init">Initilize Students</button>
  
  <iframe id="iframe"></iframe>
  <script src="../../config.js"></script>
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, writeBatch, deleteDoc, getDocs, getCountFromServer, collection, query, where, updateDoc, arrayUnion, doc, setDoc, getDoc, runTransaction} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
      const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
}; 
  
  
  const schoolId = "capital";
     // Replace with your Cloudinary details
  //const cloudName = "daktkkz2k"; // Replace with your Cloudinary cloud name
 // const uploadPreset = "passport"; // Replace with your unsigned preset
  const cloudName = "dwmknlhpa";
  const uploadPreset = "uty99obt";
  // const schoolId = "alhidayah";
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const batch = writeBatch(db);
  
  const stdApp = initializeApp(studentsConfig, "std"); 
  const stdDb = getFirestore(stdApp);
  var stdBatch; 
  
  let currentStudents = null;
    
    const terms = ["first term", "second term", "third term"];

  let sessionsRef = doc(db, schoolId, "sessions");
  //let studentsRef = doc(db, schoolId, "classes");
  const sessionsDoc = await getDoc(sessionsRef);
  var sessionIndex;
    
  if (sessionsDoc.exists()){
      
     let sessions = sessionsDoc.data().sessions      
     sessions =  sessions.sort((a, b)=>b.no - a.no);
    sessions.forEach((session, i)=>{
      let year = session.year;
      let opt = document.createElement("option");
      opt.innerHTML = year + ", " + terms[session.term];
      sessionSelect.appendChild(opt);
        opt.dataset.index = i;
        if (i==0){
            opt.selected = true; 
          
            sessionIndex = session.term; 
        }
       
    });
      
      //sessionSelect.firstChild.nextElementSibling.selected = true;
  }
  
  
  let sectionRef = doc(db, schoolId, "section");
let sectionDoc = await getDoc(sectionRef);
var section;
  /*head.ondblclick = e=>{
    stdBatch = writeBatch(stdDb);
    init.click();
  }*/
 onAuthStateChanged(auth, async user=>{ 
       if (!user) return;
      let id = user.email.replace(/@.*/, "");
      let teachers = (await getDoc(doc(db, schoolId, "teachers"))).data()
       let teacher = teachers[id];
       if (sectionDoc.exists()){
           let sections = sectionDoc.data();
           let hosSects = teacher.role.hos.sections;
           let keys = Object.keys(sections);
           hosSects.forEach(key=>{
               let optG = document.createElement("optgroup");
               optG.label = key;
               let classes = sections[key].classes;
               classes.forEach(clas=>optG.innerHTML +=`<option>${clas}</option>`);
               classSelect.append(optG);
             classSelect.addEventListener("change", _=>{
               if (!classes.includes(classSelect.value)) return;
               section = key;
               console.log(section);
             })
           });
       }
       
   })
  

  function addRow(result){
    //console.log(result.gender=="Male");
    //result.name = nameIn.textContent.toLowerCase().trim();
    result.names = result.name.toLowerCase().split(" ");
    const parent = result.parent;
    const container = document.getElementById('table');
    const row = document.createElement('tr');
    let clas = key(classSelect.value);
    if (!clas) return;
    row.classList.add("record");
    //console.log(result.picURL);
    let picURL = optimizeCloudinaryUrl(result.picURL);
      row.innerHTML = `
      <td class="passport">
      <!-- Pict -->
      <input type="file" accept="image/*" capture="environment" id="cameraInput">
      </td>
      <td class="id">${result.id??"Not Yet Generated"}</td>
       <td class="name" contenteditable>
        ${result.name.toUpperCase()}
      </td> 
      <td>
         <select class="gender">
            <option value=""> -select gender- </option>
            <option value="female">Female</option>
           <option value="male">Male</option>
        </select>  
    </td>    
    <td>
    <select class="religion" value="Islam">
         <option value=""> -select religion- </option>
         <option value="Islam">Muslim</option>
         <option value="Christian">Christian</option>
    </select>
    </td>
    <td class="scores">
    PIN: ****
    </td> 
      `;


    let pinElm = row.querySelector(".scores");
    pinElm.ondblclick = async e=>{
       if (!result.id) return;
       const stdRef = doc(stdDb, "students", result.id.replaceAll("/", "_"))
       pinElm.innerHTML = "PIN: retrieving..";
       let stdDoc = await getDoc(stdRef);
       let std = stdDoc.data();       
       pinElm.innerHTML = "PIN: "+ std.pin;
      }
      container.appendChild(row);
      let psp = row.querySelector(".passport");
      let imgIn = psp.querySelector("input");
      let preview = psp.querySelector("img");
      imgIn.onchange = async (event) => {
      const file = event.target.files[0];
      if (!file) return;
    
      // Show temporary preview
      
      // Prepare upload
      const formData = new FormData();
      formData.append("file", file);
      formData.append("upload_preset", uploadPreset);

      try {
        const res = await fetch(
          `https://api.cloudinary.com/v1_1/${cloudName}/image/upload`,
          { method: "POST", body: formData }
        );
        const data = await res.json();
        preview.src = data.secure_url; // Final Cloudinary URL
        //console.log("Uploaded to Cloudinary:", data.secure_url);
        result.picURL = data.secure_url;
       /* if (result.id){
          await setDoc(doc(db, schoolId, "db", "students", id.replaceAll("/", "_")), {picURL: data.secure_url}, {merge:true});
        }*/
        alert("done!");
      } catch (err) {
        alert("Upload failed: " + err.message);
      }
    };
      psp.ondblclick = e=>{
          imgIn.click();
      }
     // row.scrollIntoView();
     // let id = "std"+result.sn;
      let nameIn = row.querySelector(".name");
      nameIn.oninput = e=>{
          result.name = nameIn.textContent.toLowerCase().trim();
        result.names = result.name.split(" ");
      }
      let genderIn = row.querySelector(".gender");
      genderIn.onchange = e=>{
          result.gender = genderIn.value; //.toLowerCase();
      }
    let relIn = row.querySelector(".religion");
      relIn.onchange = e=>{
          result.religion = relIn.value; //.toLowerCase();
      }
    relIn.value = result.religion;
    //console.log(result.id, result.religion);
     if (result.gender.toLowerCase()[0]=="m" || result.gender.toLowerCase()[0] == "f") 
      genderIn.value = !result.gender? "" : result.gender.toLowerCase();
  }
add.onclick = e=>{
  let result ={
    sn: table.children.length,
    name: "",
    gender: "",
    religion: "",
    pin: generate4DigitInteger()
  }
  addRow(result);
    let lastN = Number(result.sn);
    while (currentStudents["std"+lastN]){
        lastN++;
    }
  currentStudents["std"+lastN] = result;
}
  
   /* printBtn.onclick = e=>{
        window.print();
    }*/
  saveBtn.onclick = async e=>{
    let clas = key(classSelect.value);
    let session = key(sessionSelect.value);
    if (!(clas && session)) return;
    let stdsRef = doc(db, schoolId, session, clas, "students");   
    if (!currentStudents) return;
    if (!Object.values(currentStudents).length) return;
    saveBtn.innerHTML = "saving..";
    saveBtn.disabled = true;
    await batch.commit();
    stdBatch = writeBatch(stdDb);
    await runTransaction(db, async transaction=>{
      let stdsDoc = await transaction.get(stdsRef);
      let stds = stdsDoc.exists()? stdsDoc.data() : {};
      
      for (const stdId in currentStudents){
        const localStd = currentStudents[stdId];
        
        if (stds[stdId] && !isEqual(localStd, stds[stdId]) && stds[stdId].id){
          //alert();
         // return;
         
         await transaction.update(doc(db, schoolId, "db", "students", stds[stdId].id.replaceAll("/", "_")), localStd);
         updateStudent(localStd, stdBatch);
        }
      }
      await transaction.set(stdsRef, currentStudents);
      await stdBatch.commit();
   });
    await loadStudents();
    
    saveBtn.innerHTML = "saved!";
    saveBtn.disabled = false;
    setTimeout(_=>saveBtn.innerHTML = "Save", 2000);
    //console.log(JSON.stringify(students));
     
  }
  
  classSelect.onchange = async e=>{
    loadStudents();
  }
    sessionSelect.onchange = async e=>{
        if (!e.target.value) return;
      //console.log(e.target.value); return;
        loadStudents();
        let opt = sessionSelect.selectedOptions[0];
        sessionIndex = opt.dataset.index;
        //console.log(sessionIndex);
        
  }
    
    
 
    async function loadStudents(){
        table.innerHTML = "";
        let clas = key(classSelect.value);
      let session = key(sessionSelect.value);
    if (!(clas && session)) return;
    let cls = classSelect.value.toLowerCase();
    let year = sessionSelect.value.split(",")[0].trim().replaceAll(" ", "");
    //console.log(year);
    let yearsNum = sessionsDoc.data().sessions.length;
    let activeYear = sessionsDoc.data().sessions[yearsNum-1].year.trim().replaceAll(" ", "");
    //console.log(activeYear);
    //console.log(classSelect.value);
    let q = query(collection(db, schoolId, "db", "students"), where("class", "==", cls));
    let countSnap = await getCountFromServer(q);
    let stdCountQ = query(collection(db, schoolId, "db", "students"));
    let StdCountSnap = await getCountFromServer(stdCountQ);
    let stdCount = StdCountSnap.data().count;
    //console.log("total student: ", stdCount);

    let count = countSnap.data().count;
    console.log(count);
            
    let stdsRef = doc(db, schoolId, session, clas, "students");
      //console.log(clas, session);
      
    let stdsDoc = await getDoc(stdsRef);
    let stds = stdsDoc.exists()? stdsDoc.data() : {};
      //console.log(JSON.stringify(stds).length);
    //class based std id  
    let cbsIds = Object.values(stds).map(std => std.id).filter(id=> !!id);
    let cbCount = cbsIds.length;
     console.log(Object.values(stds).length);
      //console.log(cbsIds);
      //console.log(Object.keys(stds));
      //console.log(year === activeYear);
    if (count  !== cbCount && year === activeYear) {
      //alert(); return;
        let gStdsDoc = await getDocs(q);
        let stdIds =[];
     // return;
   
      let gStudents = {};
        gStdsDoc.forEach(doc=>{
          console.log(8888);
            let std = doc.data();
            let id = std.id;
            //console.log(id);
            stdIds.push(id);
            if (!stds[id]) {
              std.picURL ??="";
              std.religion ??="";
               let {name, gender, id, picURL, religion} = std;
               stds[id] = {name, gender, id, picURL, religion};
              //console.log(std.gender, std.name, std.picURL);
           }           
        });
        let supersetIds = Array.from(new Set(cbsIds.concat(stdIds)));
        Object.keys(stds)
      .forEach(id=>{
            if (!stdIds.includes(id))
             delete stds[id]
          console.log(id);
        });
      
        await setDoc(stdsRef, stds);  
        currentStudents = stds;  
    }
    let size = Object.values(stds).length;
    if (stdsDoc.exists() || size){
      currentStudents = size? stds : stdsDoc.data();
      

        
        let upgradeRef = doc(db, schoolId,"upgrade");
        
      // await setDoc(upgradeRef, {upscaledClasses: [clas]});
     //  alert("Done");
      
     //  console.log(upgrade.upscaledClasses);
      for (const id in currentStudents){
          
          let student = currentStudents[id];
          if (!student.id/*!upgrade.upscaledClasses.includes(clas)*/){
         if (student.id) throw "Alread ided!";
              let session = sessionsDoc.data().sessions.sort((a, b)=>b.no - a.no)[0];
               let [y1, y2] = session.year.replaceAll(" ", "").split("/");
              let t = Number(session.term)+1;              
            await runTransaction(db, async transaction=>{
                //if (Number(sessionIndex)) return;
                let upgradeDoc = await transaction.get(upgradeRef);
                let upgrade = upgradeDoc.exists()? upgradeDoc.data() : {upscaledClasses: []};

                let sesDoc = await transaction.get(doc(db, schoolId, key(session.year+terms[session.term])));
                let stds = (await transaction.get(stdsRef)).data();
                let lastId = sesDoc.exists()? sesDoc.data().lastStudentId?? 0 : 0;
                lastId++;
                //console.log(lastId);
              
                const lastStdId = `${y1.slice(-2)}/${y2.slice(-2)}/${t}/${lastId}`;
              /*  let newDoc = await transaction.get(doc(db, schoolId, "db", "students", lastStdId.replaceAll("/","_")));
                if (newDoc.exists()){
                    console.log('Conflict!');
                    return
                }*/
                let upStd = {};
                student.id = lastStdId;
                upStd.class = classSelect.value.toLowerCase();
                upStd.id = student.id;
                //console.log(student.name);
                upStd.names = student.name.trim().split(" ").map(n=>n.toLowerCase());
                upStd.name = student.name.toLowerCase();
                upStd.gender = student.gender.toLowerCase();
                student.religion??="";
                upStd.religion = student.religion.toLowerCase();
                delete stds[id] 
                stds[lastStdId] = student;
                await transaction.set(doc(db, schoolId, "db", "students", upStd.id.replaceAll("/", "_")), upStd);
                await transaction.set(stdsRef, stds);
                await transaction.set(doc(db, schoolId, key(session.year+terms[session.term])), {lastStudentId: lastId}, {merge:true});
                await createStudent(upStd);
              //console.log(lastStdId);
             }) 
          }
          addRow(student)
      } 
      let table = document.getElementById("table");
      let sortedRows = Array.from(table.children).sort((a, b)=>{
        let nameA = a.querySelector(".name").textContent.trim();
        let nameB = b.querySelector(".name").textContent.trim();
        return nameA.localeCompare(nameB)      
       });
      table.append(...sortedRows);
      //  await updateDoc(upgradeRef, {upscaledClasses: arrayUnion(clas)});
        //console.log("Done");
        let opt = classSelect.selectedOptions[0];
      
    } else 
        currentStudents = {};
    }
  
  function key(token){
    return token.replaceAll(" ","").replaceAll("/", "").replaceAll(",", "");
    //.toLowerCase();
  }
 
   
function isEqual(a, b) {
  if (a === b) return true;

  if (typeof a !== "object" || a === null ||
      typeof b !== "object" || b === null) {
    return false;
  }

  // Handle arrays separately
  if (Array.isArray(a) && Array.isArray(b)) {
    if (a.length !== b.length) return false;
    return a.every((val, i) => isEqual(val, b[i]));
  }

  const keysA = Object.keys(a);
  const keysB = Object.keys(b);

  if (keysA.length !== keysB.length) return false;

  return keysA.every(key => keysB.includes(key) && isEqual(a[key], b[key]));
}

  
  function optimizeCloudinaryUrl(url, params = "f_auto,q_auto") {
    if (!url || !url.length) return "../../std-pic.jpg";
    return url.replace("/upload/", `/upload/${params}/`);
}
  
 async function searchAndMatch(stdId, stdName, stdCls){
    iframe.src = `parent/match.html?wardId=${stdId}&wardName=${stdName}&wardClass=${stdCls}`;
   iframe.classList.add("show");
    return await new Promise(resolve=>{
      window.addEventListener("message", e=>{
        if (e.data.fromParentMatching){
          //console.log("Message", JSON.stringify(e.data));
          resolve(e.data);
          iframe.classList.remove("show");
        }
      })
    });
  }

// Usage:
//const data = await searchAndMatch("child.html");
//console.log("Got:", data);
  
 init.onclick = async e=>{
    //console.log(sessionIndex);
    let cls = classSelect.value;
    let sections = sectionDoc.data();
    let scoreSheetConfig = sections[section].scoreSheetConfig;
    //assessment scale = asms
    let asms = scoreSheetConfig.assessments; //??[{name: "CA", subtotal: 30}];
    
    for(const std in currentStudents){
      let student = currentStudents[std];
      student.subjects ??={};
      let subjects = student.subjects;
      let termPerformances = {};
      for (const s in subjects){
        let subj = subjects[s][sessionIndex];
        //console.log(sessionIndex);
        termPerformances[s] = subj;
        console.log(JSON.stringify(subj))
      }
      termPerformances.asms = asms;
      let info = {
        name: student.name,
        classes: arrayUnion(classSelect.value),
        gender: student.gender,
        picURL: student.picURL || "",    
        id: student.id,
        sessions: arrayUnion(sessionSelect.value.toLowerCase()),
        section,
        pin: generate4DigitInteger()
      }
      const stdRef = doc(stdDb, "students", student.id.replaceAll("/", "_"))
      const perfRef = doc(stdDb, "students", student.id.replaceAll("/", "_"), "performances", key(sessionSelect.value))
      stdBatch.set(stdRef, info,  {merge: true})
      console.log(key(sessionSelect.value));
      stdBatch.set(perfRef, termPerformances,  {merge: true});
    }
    await stdBatch.commit();
    alert("Done");
    
    
  }
  
  function generate4DigitInteger() {
  return Math.floor(1000 + Math.random() * 9000);
}

  function updateStudent(student, batch){
          let info = {
        name: student.name,
        classes: arrayUnion(classSelect.value),
        gender: student.gender,
        picURL: student.picURL || "",    
        id: student.id,
        sessions: arrayUnion(sessionSelect.value.toLowerCase()),
        section,
        religion: student.religion || "none"
      }
     
      const stdRef = doc(stdDb, "students", student.id.replaceAll("/", "_"))
      const perfRef = doc(stdDb, "students", student.id.replaceAll("/", "_"), "performances", key(sessionSelect.value))
      batch.set(stdRef, info,  {merge: true})
      console.log(key(sessionSelect.value));
      //stdBatch.set(perfRef, termPerformances,  {merge: true});
    }
  
  async function createStudent(student){
      let info = {
        name: student.name,
        classes: arrayUnion(classSelect.value),
        gender: student.gender,
        picURL: student.picURL || "",    
        id: student.id,
        sessions: arrayUnion(sessionSelect.value.toLowerCase()),
        section,
        pin: generate4DigitInteger(),
        religion: student.religion || "none"
      }
     
      const termPerformances = {};
      const stdRef = doc(stdDb, "students", student.id.replaceAll("/", "_"))
      const perfRef = doc(stdDb, "students", student.id.replaceAll("/", "_"), "performances", key(sessionSelect.value))
      await setDoc(stdRef, info,  {merge: true})
      console.log(key(sessionSelect.value));
      await setDoc(perfRef, termPerformances,  {merge: true});
    }
   // await stdBatch.commit()
  
// Example
console.log(generate4DigitInteger()); // e.g. 4837
  </script>
</body>
</html>
