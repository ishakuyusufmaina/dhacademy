<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .dashboard {
      max-width: 1000px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .student-info {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
      text-transform: uppercase;
    }

    .student-info img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #ddd;
    }

    .student-details h2 {
      margin: 0 0 8px;
    }

    .student-details select {
      padding: 6px 10px;
      font-size: 14px;
    }

    h3 {
      margin-bottom: 15px;
      border-bottom: 2px solid #eee;
      padding-bottom: 6px;
    }
  
  #performanceTable {
    overflow: auto;
  }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      padding: 10px;
      text-align: center;
      border: 1px solid #ddd;
    }

    th {
      background: #f0f2f5;
      font-weight: bold;
    }

    tbody tr:nth-child(even) {
      background: #fafafa;
    }

    .subject-name {
      text-align: left;
      font-weight: bold;
    }
  
  button {
    padding: 10px 20px;
    background-color: #4caf50;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 10px;
    transition: background 0.3s ease;
  }
  </style>
</head>
<body>

  <div class="dashboard">
    <div>
      <button id="logout">Logout ðŸ”’</button>
    </div>
    <hr>
    <!-- Student Info -->
    <div class="student-info">
      <!--img id="studentPhoto" alt="Student Photo"-->
      <div class="student-details">
        <h2 id="studentName"></h2>
        <hr>
          <h3>
          Section:
          <span id="sectionElm"></span>
        </h3>
        <label>
          Class:
          <select id="classSelect"></select>
        </label>
      </div>
    </div>

    <!-- Academic Performance -->
    <h3>Your Academic Performance</h3>
    <div id="performanceTable"></div>
  </div>

  <script src="config.js"></script>
   <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
  import {getFirestore, doc, setDoc, getDoc} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
  import {getAuth, signOut, onAuthStateChanged} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
 const firebaseConfig = {
  apiKey: "AIzaSyCm_DSZaYVQCt0ubBwRkE9nOTryJayxH0w",
  authDomain: "school-in-the-box.firebaseapp.com",
  projectId: "school-in-the-box",
  storageBucket: "school-in-the-box.firebasestorage.app",
  messagingSenderId: "596350496353",
  appId: "1:596350496353:web:84c66c351700ddf0824420",
  measurementId: "G-3MGCDH4FRF"
}; 
  
  
  const schoolId = "capital";
  
  const app = initializeApp(studentsConfig);
  const schApp = initializeApp(firebaseConfig, "school");
  
  const analytics = getAnalytics(app);
  let id= window.localStorage.getItem("id") || "";
  id = id.replaceAll("/", "_");
  const db = getFirestore(app);
  const schDb = getFirestore(schApp);
  const stdRef = doc(db, "students", id);
  let stdDoc = await getDoc(stdRef);
  const student = stdDoc.data()
  if (!student.religion){
    let schStdDoc = await getDoc(doc(schDb, schoolId, "db", "students", id));
    student.religion = schStdDoc.data().religion || "none";
    await setDoc(stdRef, {religion: student.religion}, {merge: true});
    console.log("Religion updated", student.religion);
  }
  
  logout.onclick = e=>{
    window.localStorage.removeItem("id");
    window.location.href = "signin.html";
  }
  
    // ---------------------------
    // Sample Data  25/26/1/261
    // ---------------------------
 /*{
      name: "Aisha Bello",
      classes: ["JSS 1", "JSS 2", "JSS 3"],
      photoUrl: "https://via.placeholder.com/150"
    };*/

 let section = student.section;
console.log(section);  
  sectionElm.textContent = section.toUpperCase();
let sectDoc = await getDoc(doc(db, "sections", section));
section = sectDoc.exists()?  sectDoc.data() : {};
  
    // ---------------------------
    // Render Student Info
    // ---------------------------
    document.getElementById("studentName").textContent = student.name;
   // document.getElementById("studentPhoto").src = student.photoUrl;

    const classSelect = document.getElementById("classSelect");
    student.classes.forEach(cls => {
      const option = document.createElement("option");
      option.value = cls;
      option.textContent = cls;
      classSelect.appendChild(option);
    });
  
  const relDict = {"muslim": "islam", "christian": "christianity"};
  
    // ---------------------------
    // Build Performance Table
    // ---------------------------
    function renderPerformanceTable(data) {
      if (!data.length) return;

      const scoreHeaders = data[0].scores.map(s => s.name + ` (${s.subtotal | "-"})`);

      let table = `<table>
        <thead>
          <tr>
            <th>Subject</th>`;

      scoreHeaders.forEach(h => {
        table += `<th>${h}</th>`;
      });
      
      table += `<th>Exam</th>`;

      table += `<th>Total</th></tr>
        </thead>
        <tbody>`;
      section.subjects ??=[];
      let subjects = {};
      
      section.subjects.forEach(subj=>{
        subjects[subj.name] = subj;
        console.log(subj.name);
      })
      data.forEach(subject => {
        
       if (!subjects[subject.name]) return;
        let relMatching = relDict[subjects[subject.name].for.toLowerCase()];
        console.log(relMatching, student.religion)
        if (relMatching && relMatching!==student.religion.toLowerCase()) return;
        if (!subjects[subject.name].active) return;
        
        let total = 0;
        
        table += `<tr>
          <td class="subject-name">${subject.name}</td>`;
        total += Number(subject.exam.replace("-", 0));

        subject.scores.forEach(score => {
          total += Number(score.value.replace("-", 0));

          total += Number(score.value.replace("-", 0));
          table += `<td>${score.value}</td>`;
        });
        table += `<td><strong>${subject.exam}</strong></td>
        <td><strong>${total}</strong></td>
        </tr>`;
      });

      table += `</tbody></table>`;

      document.getElementById("performanceTable").innerHTML = table;
    }

  let session = key(student.sessions.sort().reverse()[0]);
  
   const perfRef = doc(db, "students", key(id), "performances", session);
   let perfDoc = await getDoc(perfRef);
  const perfms  = perfDoc.exists()? perfDoc.data() : {};
  
  
  const performances = [
      /*{
        name: "Mathematics",
        scores: [
          { name: "CA", value: 18 },
          { name: "Test", value: 15 },
          { name: "Exam", value: 55 }
        ]
      },
      {
        name: "English",
        scores: [
          { name: "CA", value: 20 },
          { name: "Test", value: 14 },
          { name: "Exam", value: 50 }
        ]
      },
      {
        name: "Basic Science",
        scores: [
          { name: "CA", value: 17 },
          { name: "Test", value: 16 },
          { name: "Exam", value: 58 }
        ]
      }*/
    ];
  let standard = perfms.asms;
  delete perfms.asms;
  for (const p in perfms){
    let perm = perfms[p];   
    let name = perm.subject;    
    delete perm.subject;    
    console.log(JSON.stringify(perm));
    let exam = perm.exam;
    console.log(JSON.stringify(standard), exam);
    let scores;
    if (standard) 
    scores = standard.map(s=> ({name: s.name, value: perm[s.name.toLowerCase()], subtotal: s.subtotal}))
    else scores = Object.keys(perm).map(s=> ({name: s, value: perm[s]}))
    performances.push({name, scores, exam})
  }
   renderPerformanceTable(performances);
  
  
  function key(token){
    return token.replaceAll(" ","").replaceAll("/", "").replaceAll(",", "");
    //.toLowerCase();
  }
 
  </script>

</body>
</html>
